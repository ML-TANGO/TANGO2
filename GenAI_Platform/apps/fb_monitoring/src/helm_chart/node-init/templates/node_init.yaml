apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.name }}
  labels:
    app.kubernetes.io/component: gpu-operator
spec:
  # runtimeClassName: nvidia
  backoffLimit: 0  # 실패 시 재시도하지 않음
  template:
    metadata:
        labels:
          app.kubernetes.io/component: gpu-operator
    spec:
      runtimeClassName: nvidia
      
      # tolerations:
      #   - key: nvidia.com/gpu
      #     operator: Exists
      #     effect: NoSchedule
      containers:
      - name: node-init-container
        image: {{ .Values.registry_url}}jfb-system/node-init:dev
        securityContext:
          privileged: true
        env:
        {{- range $key, $val := .Values.env }}
        - name: {{ $key }}
          value: {{ $val | quote }}
        {{- end}}
        # - name: NVIDIA_VISIBLE_DEVICES
        #   value: "all"
        # - name: PATH
        #   value: "/usr/bin:/usr/local/bin:/usr/local/cuda/bin:$PATH"
        # - name: LD_LIBRARY_PATH
        #   value: "/usr/lib/x86_64-linux-gnu:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
        envFrom:
        - configMapRef:
            name: jfb-settings
        command: ["sh", "-c", "python3 /app/src/node_init.py;"] #while true; do sleep 30; done; python3 /app/src/node_init.py 
        volumeMounts:
        - name: local-data
          mountPath: /dev/mem
        # - name: nvidia-driver
        #   mountPath: /usr/local/nvidia  # NVIDIA 드라이버와 동일한 경로
        # # - name: nvidia-smi
        # #   mountPath: /usr/bin/nvidia*   # NVIDIA 드라이버와 동일한 경로
        # - name: nvidia-driver-gnu
        #   mountPath: /usr/lib/x86_64-linux-gnu
      nodeName: {{ .Values.node }}
      volumes:
      - name: local-data
        hostPath:
          path: /dev/mem
      # - name: nvidia-driver
      #   hostPath:
      #     path: /usr/local/nvidia  # NVIDIA 드라이버가 설치된 호스트 경로
      #     type: Directory
      # # - name: nvidia-smi
      # #   hostPath:
      # #     path: /usr/bin/nvidia-smi  # NVIDIA 드라이버가 설치된 호스트 경로
      # - name: nvidia-driver-gnu
      #   hostPath:
      #     path: /usr/lib/x86_64-linux-gnu

      restartPolicy: Never
